<html>
<head>
    <title>用户信息</title>
    <link rel="stylesheet" type="text/css"
          href="../easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../easyui/demo/demo.css">
    <script type="text/javascript" src="../easyui/jquery.min.js"></script>
    <script type="text/javascript" src="../easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../easyui/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript">
        function query() {
            var userName = $("#quserName").textbox("getValue");
            var sex = $("#qsex").combobox("getValue");
            if (sex == -1) {
                sex = null;
            }
            $("#dg").datagrid("load", {
                userName: userName,
                sexCode: sex
            });
        }

        function init() {
            $("#roleDg").datagrid({
                onLoadSuccess: function (data) {
                    if (data) {
                        $.each(data.rows, function (index, item) {
                            if (item.userId != null) {
                                $('#roleDg').datagrid('checkRow', index);
                                $('#roleDg').datagrid('selectRow', index);
                            }
                        });
                    }
                }
            });
        }

        function saveOrUpdate(type) {
            $('#window').window({
                width: 760,
                height: 600,
                modal: true
            });
            $("#id").val("");
            $("#userName").textbox("setValue", "");
            $("#sex").combobox("setValue", "1");
            $("#note").textbox("setValue", "");
            var user = $("#dg").datagrid("getSelected");
            if (user == null && type == "update") {
                alert("没有选择用户信息");
                return;
            }

            $("#url").val("./" + type);
            if (type == "update") {
                // 通过get请求获取数据
                $.get("./" + user.id, function (user) {
                    $("#id").val(user.id);
                    $("#userName").textbox("setValue", user.userName);
                    $("#sex").combobox("setValue", user.sexCode);
                    $("#note").textbox("setValue", user.note);
                });
                $("#roleDg").datagrid("load", {userId: user.id})
            } else {
                $("#roleDg").datagrid("load", {});
            }
            $('#window').window('open');
        }

        function submit() {
            var userRoleList = $("#roleDg").datagrid("getChecked");
            if (userRoleList == null || userRoleList.length == 0) {
                alert("该用户未分配角色，请分配！！");
                return;
            }
            var roleIds = "";
            for (var i = 0; i < userRoleList.length; i++) {
                var userRole = userRoleList[i];
                roleIds += "," + userRole.roleId;
            }
            roleIds = roleIds.substr(1);
            var userVo = {
                userName: $("#userName").textbox("getValue"),
                sexCode: $("#sex").combobox("getValue"),
                note: $("#note").textbox("getValue"),
                roleIds: roleIds
            }
            var userId = $("#id").val();
            if (userId != null && userId != "") {
                userVo["id"] = userId;
            }
            var url = $("#url").val();
            $.ajax({
                url: url,
                type: "POST",
                data: JSON.stringify(userVo),
                contentType: "application/json",
                success: function (result) {
                    alert("保存成功");
                    $("#dg").datagrid("reload");
                    $('#window').window('close');
                }
            });
        }

        function remove() {
            var user = $("#dg").datagrid("getSelected");
            if (user == null) {
                alert("没有选择用户信息");
            }
            var selectResult = confirm("您确定删除用户的信息吗？");
            if (selectResult) {
                $.ajax({
                    url: "./" + user.id,
                    type: "DELETE",
                    success: function (result) {
                        alert("删除成功");
                        $("#dg").datagrid("reload");
                    }
                });
            } else {
                return;
            }
        }
    </script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
</head>
<body onload="init()">
<div class="easyui-layout" style="width: 100%; height: 100%;">
    <div data-options="region:'north', iconCls:'icon-ok'" title="查询框" style="height: 80px;">
        <table>
            <tr>
                <td>&nbsp;&nbsp;用户名称：</td>
                <td><input name="quserName" id="quserName" class="easyui-textbox" style="width:100%;height:32px"></td>
                <td>性别：</td>
                <td>
                    <select id="qsex" name="qsex" class="easyui-combobox" style="width:100%;height:32px">
                        <option selected value="-1">&nbsp;</option>
                        <option value="1">男</option>
                        <option value="0">女</option>
                    </select>
                </td>
                <td><a href="#" onclick="query()" class="easyui-linkbutton" data-options="iconCls:'icon-search'"
                       style="width:80px">查询</a></td>
            </tr>
        </table>
    </div>
    <div data-options="region:'center', iconCls:'icon-ok'">
        <table id="dg" class="easyui-datagrid" style="height:100%;width: 100%;" title="用户列表"
               data-options="singleSelect:true,collapsible:true,
			        url: '../users', method: 'post',
			        fitColumns:true, pagination:true, pageNumber:1, pageSize:20">
            <thead>
            <tr>
                <th data-options="field:'id',width:100">编号</th>
                <th data-options="field:'userName',width:100">用户名称</th>
                <th data-options="field:'sexCode',width:100, hidden:true">性别编码</th>
                <th data-options="field:'sexName',width:100">性别</th>
                <th data-options="field:'note',width:200">备注</th>
            </tr>
            </thead>
        </table>
    </div>
    <div style="padding:5px 0;" data-options="region:'south', iconCls:'icon-ok'">
        <a href="#" class="easyui-linkbutton" onclick="saveOrUpdate('add');" data-options="iconCls:'icon-add'">新增</a>
        <a href="#" class="easyui-linkbutton" onclick="saveOrUpdate('update');"
           data-options="iconCls:'icon-edit'">修改</a>
        <a href="#" class="easyui-linkbutton" onclick="remove();" data-options="iconCls:'icon-remove'">删除</a>
    </div>
    <div id="window" class="easyui-window" title="用户详情" data-options="modal:true,closed:true,iconCls:'icon-save'"
         style="width:0px;height:0px;padding:0px;">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'north'" style="padding:10px;height:80px;">
                <form id="role_details" method="post">
                    <input name="id" id="id" type="hidden">
                    <input name="url" id="url" type="hidden">
                    <table>
                        <tr>
                            <td>用户名称</td>
                            <td><input name="userName" id="userName" data-options="prompt:'用户名称.....'"
                                       class="easyui-textbox" style="width:100%;height:32px"></td>
                            <td>性别</td>
                            <td>
                                <select id="sex" name="sex" class="easyui-combobox" style="width:100%;height:32px">
                                    <option value="1" selected>男</option>
                                    <option value="0">女</option>
                                </select>
                            </td>
                            <td><input name="note" id="note" data-options="prompt:'备注.....'" class="easyui-textbox"
                                       style="width:100%;height:32px"></td>
                        </tr>
                    </table>
                </form>
            </div>
            <div data-options="region:'center',border:false">
                <table id="roleDg" class="easyui-datagrid" style="height:100%;width: 100%;" title="角色列表（通过复选框选择）"
                       data-options="singleSelect:true,collapsible:true,
			        url: './roles', method: 'get', singleSelect: false,
			        selectOnCheck:false, checkOnSelect:false, fitColumns:true">
                    <thead>
                    <tr>
                        <th data-options="field:'checked',checkbox:true"></th>
                        <th data-options="field:'roleId',width:100">编号</th>
                        <th data-options="field:'roleName',width:100">角色名称</th>
                        <th data-options="field:'note',width:100">当前后台选中情况</th>

                    </tr>
                    </thead>
                </table>
            </div>
            <div data-options="region:'south',border:false" style="text-align:right;padding:5px 0 0;">
                <a class="easyui-linkbutton" data-options="iconCls:'icon-save'" href="javascript:void(0)"
                   onclick="javascript:submit()" style="width:80px">保存</a>
                <a class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" href="javascript:void(0)"
                   onclick="javascript:$('#window').window('close');" style="width:80px">关闭</a>
            </div>
        </div>
    </div>
</div>
</body>
</html>